<script>
  function clearInputs() {
    document.getElementById('allocation1').value = '';
    document.getElementById('allocation2').value = '';
    document.getElementById('allocation3').value = '';
    document.getElementById('exitPrice1').value = '';
    document.getElementById('exitPrice2').value = '';
    document.getElementById('exitPrice3').value = '';
    document.getElementById('avgExitPrice').innerText = '$0.00'; // Changed to 2 decimal places
    showBubble('Cleared!', 'resetBubble');
  }

  function copyResult() {
    const resultText = document.getElementById('avgExitPrice').innerText;
    const tempInput = document.createElement('input');
    tempInput.value = resultText;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showBubble('Copied!', 'copyBubble');
  }

  function showBubble(message, bubbleId) {
    const bubble = document.getElementById(bubbleId);
    bubble.innerText = message;
    bubble.classList.add('show');

    setTimeout(() => {
      bubble.classList.remove('show');
    }, 1000);
  }

  function formatPercentage(value) {
    if (value >= 1) {
      return value.toFixed(0) + '%'; // Keep the percentage format for whole numbers
    } else {
      return (value * 100).toFixed(0) + '%'; // Format decimal to percentage
    }
  }

  function formatDollar(value) {
    return '$' + parseFloat(value).toFixed(2); // Format dollar amounts
  }

  function calculateAverageExitPrice() {
    const allocations = [
      parseFloat(document.getElementById('allocation1').value) / 100 || 0,
      parseFloat(document.getElementById('allocation2').value) / 100 || 0,
      parseFloat(document.getElementById('allocation3').value) / 100 || 0
    ];

    const exitPrices = [
      parseFloat(document.getElementById('exitPrice1').value.replace('$', '')) || 0,
      parseFloat(document.getElementById('exitPrice2').value.replace('$', '')) || 0,
      parseFloat(document.getElementById('exitPrice3').value.replace('$', '')) || 0
    ];

    let totalAllocation = allocations.reduce((sum, val) => sum + val, 0);

    // Check if total allocation exceeds 100%
    if (totalAllocation > 1) {
      document.getElementById('avgExitPrice').innerHTML = '<span style="color: red; font-weight: bold;">ERROR</span>'; 
      return;
    }

    if (totalAllocation === 0) {
      document.getElementById('avgExitPrice').innerText = '$0.00';
      return;
    }

    let weightedSum = 0;
    for (let i = 0; i < allocations.length; i++) {
      weightedSum += allocations[i] * exitPrices[i];
    }

    let avgExitPrice = weightedSum / totalAllocation;
    document.getElementById('avgExitPrice').innerText = formatDollar(avgExitPrice);
  }

  document.querySelectorAll('.input-box').forEach((input, idx) => {
    input.addEventListener('blur', function () {
      if (idx < 3) {
        const value = parseFloat(input.value) || 0;
        input.value = formatPercentage(value);
      } else {
        const value = parseFloat(input.value.replace('$', '')) || 0;
        input.value = formatDollar(value);
      }
      calculateAverageExitPrice();
    });
  });
</script>
